# makefile for testing Lua

srcdir=@srcdir@
top_srcdir=@top_srcdir@
top_builddir=@top_builddir@

EXESUF=@EXESUF@

HKSC_SUPPRESS_LOGGING=@HKSC_SUPPRESS_LOGGING@
HKSC_PREFIX_MAP=@HKSC_PREFIX_MAP@
HKSC_GEN_PROFILE=@HKSC_GEN_PROFILE@
HKSC_GEN_DEBUG=@HKSC_GEN_DEBUG@
HKSC_CMP_CODE=@HKSC_CMP_CODE@
HKSC_CMP_PROFILE=@HKSC_CMP_PROFILE@
HKSC_CMP_DEBUG=@HKSC_CMP_DEBUG@

RM=@RM@

HKSC_VERSION=@HKSC_VERSION@

# will be set to .dtest by configure if the decompiler is enabled
# *.dtest will depend on *.ctest, so compiler tests will always be run, and then
# if the decompiler is enabled, the decompiler tests will be run
TESTSUFFIX=@TESTSUFFIX@

@VPATH_SET@

# should be set by the parent Makefile in the invokation
HKSC_NAME=hksc

HKSC=$(top_builddir)/src/$(HKSC_NAME)$(EXESUF)

HKSCFLAGS=-L $(HKSC_SUPPRESS_LOGGING) $(HKSC_PREFIX_MAP)

TESTMAKEFLAGS=

MAKELOG=./tests.$(HKSC_NAME).log

ALL_SRC=	00_comment.lua \
	01_k.lua \
	02_constfold.lua \
	03_float.lua \
	04_intliteral.lua \
	05_table.lua \
	06_bigtable.lua \
	07_utf8_bom.lua \
	08_fornum.lua \
	09_forlist.lua \
	10_function.lua \
	11_repeat.lua \
	12_while.lua \
	13_do.lua \
	14_bool.lua \
	15_precedence.lua \
	16_numeric_literals.lua \
	17_recursion.lua \
	18_testset.lua \
	19_multiple_table_index.lua \
	20_break.lua \
	21_nested_break.lua

ALL_TESTS=$(ALL_SRC:.lua=@TESTSUFFIX@)

all: prepare dummy version error $(ALL_TESTS)
	@echo ----------------------------
	@echo ---------------------------- >> $(MAKELOG)
	@echo All Lua tests passed
	@echo All Lua tests passed >> $(MAKELOG)
	@echo

prepare: clean checkexpect
	@echo
	@echo Starting Lua tests...
	@echo Starting Lua tests... > $(MAKELOG)
	@echo ----------------------------
	@echo ---------------------------- >> $(MAKELOG)

checkexpect:
	@if test ! -e expect.sum; then \
		echo You need to generate expect.sum; \
		exit 1; \
	fi
	@shasum -c expect.sum >/dev/null

expectsum:
	@files= ; \
	for f in *.cexpect; do \
		files="$$files $(srcdir)/$${f%.cexpect}.lua"; \
	done; \
	shasum -U $$files > expect.sum

# for when $(TESTS) is empty
# also checks that HKSC was set properly
dummy:
	@$(HKSC) --version >/dev/null 2>&1

# check version of $(HKSC) against expected version
version:
	@echo checking \`$(HKSC) --version\` against $(HKSC_VERSION); \
	HKSC_VERSION_REGEX=`echo $(HKSC_VERSION) | sed 's/\./\\./g'`; \
	$(HKSC) --version 2>&1 | grep -iq ".*hksc[^0-9]*$$HKSC_VERSION_REGEX"

error:
	@cd $@ && $(MAKE) $(TESTMAKEFLAGS) HKSC_NAME=$(HKSC_NAME)


.SUFFIXES:
.SUFFIXES: .lua .cexpect .profileexpect .debugexpect .ctest .dtest

# .lua.luac:
# 	$(HKSC) --compile -s $< -o $@

# .lua.cexpect:
# 	@echo You need to regenerate $@!; false
# .lua.profileexpect:
# 	@echo You need to regenerate $@!; false
# .lua.debugexpect:
# 	@echo You need to regenerate $@!; false

# .profileexpect.ctest:
# 	@:
# .debugexpect.ctest:
# 	@:

# compiler test
.cexpect.ctest:
	@echo ------------ $* ------------
	@echo ------------ $* ------------ >> $(MAKELOG)
# 	generate stripped bytecode
	@echo $(HKSC) $(HKSCFLAGS) -s $(srcdir)/$*.lua -o $*.luac >> $(MAKELOG)
	@$(HKSC) $(HKSCFLAGS) -s $(srcdir)/$*.lua -o $*.luac
# 	generate profile info
	@echo $(HKSC) $(HKSCFLAGS) $(HKSC_GEN_PROFILE) $*.luaprofile \
	$(srcdir)/$*.lua >> $(MAKELOG)
	@$(HKSC) $(HKSCFLAGS) $(HKSC_GEN_PROFILE) $*.luaprofile $(srcdir)/$*.lua
# 	generate debug info
	@echo $(HKSC) $(HKSCFLAGS) $(HKSC_GEN_DEBUG) $*.luadebug \
	$(srcdir)/$*.lua >> $(MAKELOG)
	@$(HKSC) $(HKSCFLAGS) $(HKSC_GEN_DEBUG) $*.luadebug $(srcdir)/$*.lua
# 	compare code with expected
	@echo $(HKSC_CMP_CODE) $*.cexpect $*.luac >> $(MAKELOG)
	@ if $(HKSC_CMP_CODE) $*.cexpect $*.luac; then \
	echo "$*.luac OK"; fi
# 	compare profile info with expected
	@echo $(HKSC_CMP_PROFILE) $*.profileexpect $*.luaprofile >> $(MAKELOG)
	@ if $(HKSC_CMP_PROFILE) $*.profileexpect $*.luaprofile; \
	then echo "$*.luaprofile OK"; fi
# 	compare debug info with expected
	@echo $(HKSC_CMP_DEBUG) $*.debugexpect $*.luadebug >> $(MAKELOG)
	@ if $(HKSC_CMP_DEBUG) $*.debugexpect $*.luadebug; \
	then echo "$*.luadebug OK"; fi
# 	check bytecode loader by loading $*.luac and dumping it again
# 	@echo $(HKSC) $(HKSCFLAGS) --withdebug --binary $*.luac -o $*.luac

# decompiler test
.ctest.dtest:
	@ echo hello $@

Makefile: $(srcdir)/Makefile.in $(top_srcdir)/configure
	@echo regenerating test/$@
	@cd $(top_builddir) && @CONFIGURE@ > /dev/null

clean:
	-@$(RM) *.luac *.luadebug *.luaprofile *.luacallstackdb *.ctest *.dtest
	@cd error && $(MAKE) $@

.PHONY: test all checkexpect expectsum dummy clean version error

# (end of Makefile)
