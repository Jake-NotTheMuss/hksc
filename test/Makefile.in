# makefile for testing Lua

TOP=..
SRCDIR=src
TOPSRC=$(TOP)/$(SRCDIR)
HKSC_VERSION=0.0

# should be set by the parent Makefile
HKSC=echo you need to set HKSC in the parent Makefile: $$\(HKSC\) && false \#

# TESTS=version
TESTS= $(COMPILER_TESTS) $(DECOMPILER_TESTS)

TESTMAKEFLAGS=-r -s

# will be empty if built without the decompiler
# don't set this, instead add decompiler tests to $(ALL_DECOMPILER_TESTS)
DECOMPILER_TESTS=
COMPILER_TESTS= $(ALL_COMPILER_TESTS)

ALL_COMPILER_TESTS=
ALL_DECOMPILER_TESTS=

# for when $(TESTS) is empty
default:

test:
	@$(MAKE) --no-print-directory -s clean
	@$(MAKE) --no-print-directory $(TESTMAKEFLAGS) $(TESTS)

version:
	@echo checking \`$(HKSC) --version\` against $(HKSC_VERSION)
	@HKSC_VERSION_REGEX=`echo $(HKSC_VERSION) | sed 's/\./\\./g'`; \
	$(HKSC) --version | grep -iq ".*hksc[^0-9]*$$HKSC_VERSION_REGEX"


# decompiler tests use compiler output as input
$(ALL_DECOMPILER_TESTS): $(COMPILER_TESTS)

clean:

.PHONY: test clean version
