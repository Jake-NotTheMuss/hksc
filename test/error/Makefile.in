# makefile for checking hksc error messages

srcdir=@srcdir@
top_srcdir=@top_srcdir@
top_builddir=@top_builddir@

@VPATH_SET@

HKSC_SUPPRESS_LOGGING=@HKSC_SUPPRESS_LOGGING@

HKSC=$(top_builddir)/src/$(HKSC_NAME)

# -p so that no binaries get generated accidentally
HKSCFLAGS=-p --compile $(HKSC_SUPPRESS_LOGGING) --file-prefix-map=$(srcdir)=

# files are generated for each BOM that is NOT accepted by hksc
BOM_TESTS=utf16be_bom.test utf16le_bom.test utf32be_bom.test utf32le_bom.test  \
utf16or32le_bom.test unknown_bom.test
OTHER_TESTS=badbreak.test earlybreak.test earlyreturn.test  \
literaloverflow.test lud.test ui64.test #utf8_identifier.test
# error checks for when structures are enabled/disabled
NOHSTRUCTURE_TESTS=hmake.test hstructure.test typedparam.test typedvar.test
YESHSTRUCTURE_TESTS=

ALL_ERROR_TESTS= $(OTHER_TESTS) $(BOM_TESTS)

HSTRUCTURE_ERROR_CHECK=@HSTRUCTURE_ERROR_CHECK@

all: Makefile prepare $(ALL_ERROR_TESTS) $(HSTRUCTURE_ERROR_CHECK)
	@printf 'All Lua error checks passed\n\n'

prepare: clean
	@printf '\nStarting Lua error checks...\n'

nohstructure: $(NOHSTRUCTURE_TESTS)

yeshstructure: $(YESHSTRUCTURE_TESTS)

.SUFFIXES:
.SUFFIXES: .test .expect .lua

.lua.expect:
	@echo You need to regenerate $@!; false

.expect.test:
	@echo ------------ $* ------------
	EXTRAFLAGS= ; test "x$@" = "xliteraloverflow.test" && EXTRAFLAGS=-L; \
	if $(HKSC) $(HKSCFLAGS) $$EXTRAFLAGS $(srcdir)/$*.lua >/dev/null 2>$@; then \
		echo "$*.lua error check failed (no error was raised)"; exit 1; \
	else \
		if diff -u $< $@; then echo "$*.lua error check OK"; \
		else echo "$*.lua error check failed (output differs from expected)"; \
			exit 1; \
		fi; \
	fi

Makefile: $(srcdir)/Makefile.in $(top_srcdir)/configure
	@echo regenerating test/error/$@
	@cd $(top_builddir) && @CONFIGURE@ > /dev/null

clean:
	-@$(RM) *.test >/dev/null 2>&1

.PHONY: all prepare clean nohstructure yeshstructure

# (end of Makefile)
