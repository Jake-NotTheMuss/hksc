#!/bin/sh
# developer configure script for libhksc
#

logfile=config.log
configstatus=config.status

# the default configuration (this project is made primarily for Black Ops III)
defaultbuildsetting=codt7

commandline="$0 $*"
test $# -lt 1 && commandline="$0"

# start of configure.log
echo -------------------- > $logfile
echo $0 $* >> $logfile
date >> $logfile

# get source directory
SRCDIR=`dirname $0`
if test $SRCDIR = "."; then
	SRCDIR=""
else
	SRCDIR="$SRCDIR/"
fi
SRCDIR="${SRCDIR}src"

infolog()
{
	echo $* | tee -a $logfile
}

error()
{
	infolog "$0: error: $*"
	exit 1
}

warn()
{
	infolog "warning: $*"
}

reset=0

varstatus()
{
	# $1 = variable name
	# $2 = default value
	test $reset = 1 && eval "unset $1"
	eval "val=\${$1:-$2}"
	eval "$1=$val"
	echo "$1=$val"
}

updateconfigstatus()
{
	cat <<EOF > $configstatus
# $configstatus: configure settings for libhksc
# $commandline
# `date`

# install paths
`varstatus prefix /usr/local`
`varstatus exec_prefix $prefix`
`varstatus libdir $exec_prefix/libdir`
`varstatus sharedlibdir $libdir`
`varstatus includedir $prefix/include`
`varstatus mandir $prefix/share/man`

# emulate ui64 using structures with a hi/lo field for C89 with no 64-bit type
# default value is 1 when developing for testing
`varstatus EMU_UI64 1`
# build decompiler machinery
`varstatus DECOMPILER 1`
# make a release build
`varstatus release 0`
# build configuration label (named after the games that use a particular config)
`varstatus buildsetting $defaultbuildsetting`
# enable loading/dumping bytecode for multiple platforms in one binary
`varstatus multiplat 0`
# enable logging in Lua
`varstatus LOGGING 0`

# compatibility settings
`varstatus STRUCTURE_EXTENSION_ON 0`
`varstatus WITHNATIVEINT 0`
`varstatus WITHDOUBLES 0`
`varstatus SELF 0`
`varstatus GETGLOBAL_MEMOIZATION 0`

# set which decompiler pass to test (0 means none)
`varstatus debugpass 0`

# shared library extension
`varstatus sharedext`
EOF
	reset=0
}

configuremakefile()
{
	sed < $1.in "
	/^CC *=/s#=.*#=$CC#
	/^MYCFLAGS *=/s#=.*#=$CFLAGS#
	/^MYLDFLAGS *=/s#=.*#=$LDFLAGS#
	/^SRCDIR *=/s#=.*#=$SRCDIR#
	/^SHAREDLIB *=/s#=.*#=$SHAREDLIB#
	/^prefix *=/s#=.*#=$prefix#
	/^exec_prefix *=/s#=.*#=$exec_prefix#
	/^libdir *=/s#=.*#=$libdir#
	/^sharedlibdir *=/s#=.*#=$sharedlibdir#
	/^includedir *=/s#=.*#=$includedir#
	/^mandir *=/s#=.*#=$mandir#
	/^DECOMPILER_TESTS *=/s#=.*#=$DECOMPILER_TESTS#
	" > $1
}
VERSION=0.0.0
configurepc()
{
	sed < $1.in "
	s/@prefix@/$prefix/g
	s/@exec_prefix@/$exec_prefix/g
	s/@libdir@/$libdir/g
	s/@sharedlibdir@/$sharedlibdir/g
	s/@includedir@/$includedir/g
	s/@VERSION@/$VERSION/g
	" > $1
}

configureheader()
{
	sed < $1.in "
	s/@LUACONFIG_EMU_UI64@/$EMU_UI64/g
	s/@LUACONFIG_DECOMPILER@/$DECOMPILER/g
	s/@LUACONFIG_LOGGING@/$LOGGING/g
	s/@LUACONFIG_COD@/$LUA_COD/g
	s/@LUACONFIG_CODT7@/$LUA_CODT7/g
	s/@HKSC_GETGLOBAL_MEMOIZATION@/$GETGLOBAL_MEMOIZATION/g
	s/@HKSC_STRUCTURE_EXTENSION_ON@/$STRUCTURE_EXTENSION_ON/g
	s/@HKSC_SELF@/$SELF/g
	s/@HKSC_WITHNATIVEINT@/$WITHNATIVEINT/g
	s/@HKSC_WITHDOUBLES@/$WITHDOUBLES/g
	s/@HKSC_DEBUG_PASS@/$debugpass/g
	" > $1
}

configurefile()
{
	for v; do
		case "${v##*.}" in
			*Makefile) configuremakefile $v ;;
			pc) configurepc $v ;;
			h) configureheader $v ;;
		esac
	done
}

LC_ALL=C
export LC_ALL

# C compiler
test x$CC = x && CC=cc || echo CC=$CC

# create the config file with default values if it doesn't exist
test -e $configstatus || updateconfigstatus

# load existing config settings
. $configstatus

show_help()
{
	cat <<EOF
Usage: $0 [options]

Options:
  --help                   Print this message and exit
  --debug-pass=NUMBER      Debug decompiler pass NUMBER
  --configfile=FILE        Regenerate FILE
  --reset, --default       Reset configuration to default settings
  --prefix=PATH            Set prefix path for installed files
  --eprefix=PATH           Set exec_prefix path for installed files
  --emu-ui64               Use C struct to emulate UI64 values, disabled by
                           default
  --no-emu-ui64            Check for supported 64-bit types before resorting to
                           emulation using C struct
  --with-decompiler        Enable Lua decompiler, enabled by default
  --no-decompiler          Disable building Lua decompiler
  -r, --release            Build a release binary
  -d, --debug              Build a debug binary
  -b, --build=GAME         Configure compatibility settings for GAME
                           Supported values:
                             codt6
                             codt7
  --with-logging           Enable logging information and warning mesages
  --disable-logging        Disable logging, disabled by default
  --                       Stop handling options
EOF
	exit 0
}

prefix=${prefix-/usr/local}
exec_prefix=${exec_prefix-'${prefix}'}
libdir=${libdir-'${exec_prefix}/lib'}
sharedlibdir=${sharedlibdir-'${libdir}'}
includedir=${includedir-'${prefix}/include'}
mandir=${mandir-'${prefix}/share/man'}

# shared library extension
test x$sharedext = x && case `(uname -s || echo unknown) 2>/dev/null` in
	Darwin* | darwin*)
		sharedext='.dylib' ;;
	*)
		sharedext='.so' ;;
esac

SHAREDLIB=libhksc$sharedext

configfiles=

while test $# -ge 1; do
	case "$1" in
		-h* | --help) show_help ;;
		--reset | --default)
			rm -f -- $configstatus
			reset=1
			updateconfigstatus
			. $configstatus ;;
		--debug-pass=*) debugpass=`echo $1 | sed 's/.*=//'` ;;
		--configfile=*) configfiles="$configfiles $(echo $1 | sed 's/.*=//')" ;;
	    -p*=* | --prefix=*) prefix=`echo $1 | sed 's/.*=//'` ;;
	    -e*=* | --eprefix=*) exec_prefix=`echo $1 | sed 's/.*=//'` ;;
	    -l*=* | --libdir=*) libdir=`echo $1 | sed 's/.*=//'` ;;
	    --sharedlibdir=*) sharedlibdir=`echo $1 | sed 's/.*=//'` ;;
	    -i*=* | --includedir=*) includedir=`echo $1 | sed 's/.*=//'` ;;
		--emu-ui64) EMU_UI64=1 ;;
		--no-emu-ui64) EMU_UI64=0 ;;
		--no-dec* | --disable-dec*) DECOMPILER=0 ;;
		--with-dec* | --enable-dec*) DECOMPILER=1 ;;
		-r | --release | --no-debug) release=1 ;;
		-d | --debug | --no-rel*) release=0 ;;
		-b=* | --build=*) buildsetting=`echo $1 | sed 's/.*=//'` ;;
		-b | --build) shift; buildsetting=$1 ;;
		--with-log* | --enable-log*) LOGGING=1 ;;
		--no-log* | --disable-log*) LOGGING=0 ;;
		--)
			shift
			break ;;
		*)
			echo "unknown option: $1" | tee -a $logfile
			echo "$0 --help for help" | tee -a $logfile
			exit 1 ;;
	esac
	shift
done

test $debugpass -gt 2 && error "the decompiler only does 2 passes"

test $debugpass != 0 && \
test $debugpass != 1 && \
test $debugpass != 2 && error "invalid value for --debug-pass: $debugpass"

# configure compatibility settings based on the build config type
case "$buildsetting" in
	cod)
		warn "ambiguous build setting 'cod', setting build config to 'codt6'" ;;
	codt6 | codt7) ;; # cod builds disable all compatibility settings
	# add other titles below as their compatibility features become supported
	*) error "Unsupported build configuration '$buildsetting'" ;;
esac

case "$buildsetting" in
	codt6) LUA_COD=1 ;;
	codt7) LUA_COD=1; LUA_CODT7=1 ;;
esac

if test $release = 0; then
	CFLAGS='$(TESTS)'
else
	CFLAGS='$(RELEASE)'
fi

if test $DECOMPILER = 0; then
	# skip decompiler tests
	DECOMPILER_TESTS=
else
	DECOMPILER_TESTS='$(ALL_DECOMPILER_TESTS)'
fi

# do this before config.status is updated, the point of specifying files to
# regenerate is that it avoids touching unrelated files that would trigger a
# complete rebuild 
test "x$configfiles" != "x" && {
	configurefile $configfiles
	exit
}

updateconfigstatus

infolog "updated configuration settings in '$configstatus'"

logvar()
{
	eval "val=\$$1"
	infolog $1 = $val
}

infolog "--------------------"
logvar prefix
logvar exec_prefix
logvar libdir
logvar sharedlibdir
logvar includedir
logvar mandir
logvar release
logvar buildsetting
logvar multiplat
logvar EMU_UI64
logvar LOGGING
logvar DECOMPILER
logvar LUA_COD
logvar LUA_CODT7
logvar debugpass
infolog "--------------------"

infolog ""

infolog "Compatibility settings for '$buildsetting'"
infolog "--------------------"
logvar GETGLOBAL_MEMOIZATION
logvar STRUCTURE_EXTENSION_ON
logvar SELF
logvar WITHNATIVEINT
logvar WITHDOUBLES
infolog "--------------------"

configurefile Makefile $SRCDIR/Makefile test/Makefile $SRCDIR/hkscconf.h

exit 0
